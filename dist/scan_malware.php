<?php
require_once "../conf/config.php";
checkLogin();

// MenuName: Security Scanner

set_time_limit(0);

$dangerous_functions = ['eval', 'exec', 'shell_exec', 'system', 'passthru', 'base64_decode', 'gzinflate', 'str_rot13', 'create_function'];
$suspicious_patterns = ['eval\(base64_decode', 'eval\(gzinflate', 'preg_replace\(.*/e', 'assert\(', 'include\($_GET'];

$results = [];

if (isset($_POST['start_scan'])) {
    write_log("SECURITY_SCAN", "Memulai pemindaian keamanan sistem.");
    function scanDirectory($dir, &$results) {
        global $dangerous_functions, $suspicious_patterns;
        $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir));
        foreach ($files as $file) {
            if ($file->isFile() && strtolower($file->getExtension()) === 'php') {
                $path = $file->getRealPath();
                $code = @file_get_contents($path);
                if (!$code) continue;

                $file_issues = [];

                foreach ($dangerous_functions as $func) {
                    if (stripos($code, $func) !== false) {
                        $file_issues[] = ['type' => 'Warning', 'detail' => "Fungsi: $func"];
                    }
                }

                foreach ($suspicious_patterns as $pattern) {
                    if (preg_match("/$pattern/i", $code)) {
                        $file_issues[] = ['type' => 'Critical', 'detail' => "Pola: $pattern"];
                    }
                }

                if (!empty($file_issues)) {
                    $results[] = [
                        'file' => str_replace(realpath(__DIR__ . '/..'), '', $path),
                        'issues' => $file_issues
                    ];
                }
            }
        }
    }
    scanDirectory(realpath(__DIR__ . '/..'), $results);
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Scanner - BexMedia</title>
    <link rel="stylesheet" href="../css/index.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .scanner-container { margin-top: 24px; }
        .premium-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        .scan-anim {
            width: 120px;
            height: 120px;
            margin: 0 auto 32px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scan-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .issue-item {
            background: rgba(239, 68, 68, 0.05);
            border-left: 3px solid #ef4444;
            padding: 16px;
            margin-bottom: 12px;
            text-align: left;
            border-radius: 0 8px 8px 0;
        }
        .issue-warning { border-color: #f59e0b; background: rgba(245, 158, 11, 0.05); }
    </style>
</head>
<body>
    <div class="container">
        <?php include "sidebar.php"; ?>
        
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1>System Vulnerability Scanner</h1>
                    <p>Memindai kode sumber untuk mendeteksi backdoor, shell injection, dan fungsi berbahaya.</p>
                </div>
            </header>

            <div class="scanner-container">
                <?php if (!isset($_POST['start_scan'])): ?>
                    <div class="premium-card">
                        <div class="scan-anim">
                            <div class="scan-circle"></div>
                            <i data-lucide="shield-check" size="48" color="var(--primary-color)"></i>
                        </div>
                        <h2>Ready to Scan</h2>
                        <p style="opacity: 0.6; margin-bottom: 32px; max-width: 400px; margin-inline: auto;">
                            Pemindaian akan memeriksa seluruh direktori aplikasi BexMedia. Proses ini mungkin memakan waktu beberapa saat tergantung jumlah file.
                        </p>
                        <form method="POST">
                            <button type="submit" name="start_scan" class="btn btn-primary" style="padding: 16px 48px;">
                                Start Diagnosis
                            </button>
                        </form>
                    </div>
                <?php else: ?>
                    <div class="premium-card" style="text-align: left;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                            <h2 style="color: var(--primary-color);">Scan Results</h2>
                            <a href="scan_malware.php" class="btn btn-outline btn-sm">New Scan</a>
                        </div>

                        <?php if (empty($results)): ?>
                            <div style="text-align: center; padding: 40px;">
                                <i data-lucide="check-circle" size="64" color="#10b981" style="margin-bottom: 16px;"></i>
                                <h3 style="color: #10b981;">System Clean!</h3>
                                <p>Tidak ditemukan ancaman keamanan pada file PHP.</p>
                            </div>
                        <?php else: ?>
                            <div style="margin-bottom: 24px;">
                                <strong>Ditemukan <?= count($results) ?> file bermasalah:</strong>
                            </div>
                            <?php foreach ($results as $item): ?>
                                <div class="issue-box" style="margin-bottom: 32px;">
                                    <div style="background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; margin-bottom: 12px;">
                                        <?= h($item['file']) ?>
                                    </div>
                                    <?php foreach ($item['issues'] as $issue): ?>
                                        <div class="issue-item <?= $issue['type'] == 'Warning' ? 'issue-warning' : '' ?>">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-weight: 700; font-size: 0.75rem; letter-spacing: 0.05em; color: <?= $issue['type'] == 'Warning' ? '#f59e0b' : '#ef4444' ?>;">
                                                    <?= strtoupper($issue['type']) ?>
                                                </span>
                                            </div>
                                            <div style="font-size: 0.9rem; margin-top: 4px;">
                                                Terdeteksi <?= h($issue['detail']) ?>
                                            </div>
                                        </div>
                                    <?php endforeach; ?>
                                </div>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>
            </div>
        </main>
    </div>

    <script>lucide.createIcons();</script>
</body>
</html>
